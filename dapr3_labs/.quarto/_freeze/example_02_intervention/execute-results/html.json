{
  "hash": "31dc753730bc699eb476bf2b5c892291",
  "result": {
    "markdown": "---\ntitle: 'Analysis Example: Intervention'\nlink-citations: yes\ncode-fold: true\nparams: \n    SHOW_SOLS: TRUE\n    TOGGLE: TRUE\n---\n\n\n\n\n:::frame\n \nEach of these pages provides an analysis run through for a different type of design. Each document is structured in the same way:  \n\n  - First the data and research context is introduced. For the purpose of these tutorials, we will only use examples where the data can be shared - either because it is from an open access publication, or because it is unpublished or simulated. \n  - Second, we go through any tidying of the data that is required, before creating some brief descriptives and visualizations of the raw data.\n  - Then, we conduct an analysis. Where possible, we translate the research questions into formal equations prior to fitting the models in **lme4**. Model comparisons are conducted, along with checks of distributional assumptions on our model residuals. \n  - Finally, we visualize and interpret our analysis.\n  \nPlease note that there will be only minimal explanation of the steps undertaken here, as these pages are intended as example analyses rather than additional labs readings. Please also be aware that there are many decisions to be made throughout conducting analyses, and it may be the case that you disagree with some of the choices we make here. As always with these things, it is how we justify our choices that is important. We warmly welcome any feedback and suggestions to improve these examples: please email [ug.ppls.stats@ed.ac.uk](mailto:ug.ppls.stats@ed.ac.uk). \n\n:::\n \n# Overview \n\nIntervention studies are where the researchers _intervenes_ (e.g. through administration of a drug or treatment) as part of the study\n\nThe data used for this worked example are simulated to represent data from 50 participants, each measured at 3 different time-points (pre, during, and post) on a measure of stress. Half of the participants are in the control group, and half are in the treatment group (e.g. half received some cognitive behavioural therapy (CBT), half did not). \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(983)\nlibrary(tidyverse)\nsimMIX <- tibble(\n  ppt = factor(rep(paste(\"ID\", 1:50, sep=\"\"),each=3)),\n  ppt_int = rep(rnorm(50,0,15), each=3), \n  stress = round(\n    c(rnorm(75,c(50,45,42),sd=c(5, 6, 5)),\n      rnorm(75,c(55,30,20),sd=c(6, 10, 5))) + ppt_int,\n    0),\n  time = as_factor(rep(c(\"Pre\", \"During\", \"Post\"), 50)),\n  group = as_factor(c(rep(\"Control\", 75), rep(\"Treatment\", 75)))\n) %>% select(-ppt_int)\n```\n:::\n\n\n# Data Wrangling\n\nBecause we simulated our data, it is already nice and tidy. Each observation is a row, and we have variable indicating participant identifier (the `ppt` variable).  \n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsummary(simMIX)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      ppt          stress           time          group   \n ID1    :  3   Min.   :-13.00   Pre   :50   Control  :75  \n ID10   :  3   1st Qu.: 29.00   During:50   Treatment:75  \n ID11   :  3   Median : 43.00   Post  :50                 \n ID12   :  3   Mean   : 42.22                             \n ID13   :  3   3rd Qu.: 55.75                             \n ID14   :  3   Max.   : 90.00                             \n (Other):132                                              \n```\n:::\n\n```{.r .cell-code}\nbind_rows(head(simMIX), tail(simMIX))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 12 Ã— 4\n   ppt   stress time   group    \n   <fct>  <dbl> <fct>  <fct>    \n 1 ID1       65 Pre    Control  \n 2 ID1       81 During Control  \n 3 ID1       55 Post   Control  \n 4 ID2       62 Pre    Control  \n 5 ID2       57 During Control  \n 6 ID2       67 Post   Control  \n 7 ID49      58 Pre    Treatment\n 8 ID49      34 During Treatment\n 9 ID49      25 Post   Treatment\n10 ID50      35 Pre    Treatment\n11 ID50      21 During Treatment\n12 ID50       0 Post   Treatment\n```\n:::\n:::\n\n# Descriptives\n\nWe now have two factors of interest, scores over `Time` and by `Group`. So we do our descriptive statistics by multiple grouping factors.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsumMIX <- \n  simMIX %>%\n  group_by(time, group) %>%\n  summarise(\n    N = n_distinct(ppt),\n    Mean = round(mean(stress, na.rm=T),2),\n    SD = round(sd(stress, na.rm=T),2)\n    )\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(kableExtra)\nkable(sumMIX) %>%\n  kable_styling(\"striped\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> time </th>\n   <th style=\"text-align:left;\"> group </th>\n   <th style=\"text-align:right;\"> N </th>\n   <th style=\"text-align:right;\"> Mean </th>\n   <th style=\"text-align:right;\"> SD </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Pre </td>\n   <td style=\"text-align:left;\"> Control </td>\n   <td style=\"text-align:right;\"> 25 </td>\n   <td style=\"text-align:right;\"> 52.84 </td>\n   <td style=\"text-align:right;\"> 14.60 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Pre </td>\n   <td style=\"text-align:left;\"> Treatment </td>\n   <td style=\"text-align:right;\"> 25 </td>\n   <td style=\"text-align:right;\"> 54.76 </td>\n   <td style=\"text-align:right;\"> 16.78 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> During </td>\n   <td style=\"text-align:left;\"> Control </td>\n   <td style=\"text-align:right;\"> 25 </td>\n   <td style=\"text-align:right;\"> 49.64 </td>\n   <td style=\"text-align:right;\"> 13.23 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> During </td>\n   <td style=\"text-align:left;\"> Treatment </td>\n   <td style=\"text-align:right;\"> 25 </td>\n   <td style=\"text-align:right;\"> 30.44 </td>\n   <td style=\"text-align:right;\"> 15.49 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Post </td>\n   <td style=\"text-align:left;\"> Control </td>\n   <td style=\"text-align:right;\"> 25 </td>\n   <td style=\"text-align:right;\"> 46.08 </td>\n   <td style=\"text-align:right;\"> 14.24 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Post </td>\n   <td style=\"text-align:left;\"> Treatment </td>\n   <td style=\"text-align:right;\"> 25 </td>\n   <td style=\"text-align:right;\"> 19.56 </td>\n   <td style=\"text-align:right;\"> 15.99 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n# Visualizations\n\nWe can use a violin plot to visualize our data.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsimMIX %>% \n  ggplot(aes(x=time, y=stress, color=group, fill=group))  + \n  geom_violin(alpha = .25) + \n  geom_dotplot(binaxis='y', stackdir='center', position=position_dodge(1),\n               dotsize = 0.5) +\n  labs(x=\"Time\", y = \"Stress Score\", \n       title=\"Stress over Time by Treat Vs Control\", color=\"Condition\", fill=\"Condition\")\n```\n\n::: {.cell-output-display}\n![](example_02_intervention_files/figure-html/unnamed-chunk-5-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nIt is useful to note that the violin plot contains much of the same information that a more traditional boxplot would have, but provides more information on the actual distribution with groups as it draws on density plots.\n\nWhat we can see here is that over time, the control group shows little change, but the treatment group shows distinct declines.  \nWe can also consider line plots with separate facets for each condition:\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsimMIX %>% \n  ggplot(aes(x=time, y=stress, col=group))  + \n  geom_point(size=3, alpha=.4)+\n  geom_line(aes(group=ppt), alpha=.3)+\n  stat_summary(geom=\"pointrange\", col=\"black\")+\n  facet_wrap(~group)+\n  labs(x=\"Time\", y = \"Stress Score\", \n       title=\"Stress over Time by Treat Vs Control\", color=\"Condition\", fill=\"Condition\")+\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](example_02_intervention_files/figure-html/unnamed-chunk-6-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n# Analysis\n\n## Equations\n\n\n\n$$\n\\begin{aligned}\n  \\operatorname{stress}_{i[j]}  &= \\beta_{0i} + \\beta_{1i}(\\operatorname{timeDuring}_j) + \\beta_{2i}(\\operatorname{timePost}_j) + \\varepsilon_{i[j]} \\\\\n  \\beta_{0i} &= \\gamma_{00} + \\gamma_{01}(\\operatorname{groupTreatment}_i) + \\zeta_{0i} \\\\\n  \\beta_{1i} &= \\gamma_{10} + \\gamma_{11}(\\operatorname{groupTreatment}_i) \\\\\n  \\beta_{2i} &= \\gamma_{20} + \\gamma_{21}(\\operatorname{groupTreatment}_i) \\\\\n  & \\text{for ppt i = 1,} \\dots \\text{, I}\n\\end{aligned}\n$$\n\n\n## Fitting the models\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(lme4)\n```\n:::\n\n\n\nBase model:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nm0 <- lmer(stress ~ 1 +\n             (1 | ppt), data = simMIX)\nsummary(m0)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed model fit by REML ['lmerMod']\nFormula: stress ~ 1 + (1 | ppt)\n   Data: simMIX\n\nREML criterion at convergence: 1286.7\n\nScaled residuals: \n     Min       1Q   Median       3Q      Max \n-2.02099 -0.49670  0.01511  0.49445  1.96548 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n ppt      (Intercept) 179.7    13.40   \n Residual             209.7    14.48   \nNumber of obs: 150, groups:  ppt, 50\n\nFixed effects:\n            Estimate Std. Error t value\n(Intercept)   42.220      2.234    18.9\n```\n:::\n:::\n\n\nMain effects: \n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nm1 <- lmer(stress ~ 1 + time + group +\n             (1 | ppt), data = simMIX)\nsummary(m1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed model fit by REML ['lmerMod']\nFormula: stress ~ 1 + time + group + (1 | ppt)\n   Data: simMIX\n\nREML criterion at convergence: 1185.9\n\nScaled residuals: \n     Min       1Q   Median       3Q      Max \n-1.69666 -0.62649  0.01574  0.59245  1.92387 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n ppt      (Intercept) 166.57   12.91   \n Residual              98.01    9.90   \nNumber of obs: 150, groups:  ppt, 50\n\nFixed effects:\n               Estimate Std. Error t value\n(Intercept)      61.100      3.046  20.061\ntimeDuring      -13.760      1.980  -6.950\ntimePost        -20.980      1.980 -10.596\ngroupTreatment  -14.600      3.992  -3.657\n\nCorrelation of Fixed Effects:\n            (Intr) tmDrng timPst\ntimeDuring  -0.325              \ntimePost    -0.325  0.500       \ngroupTrtmnt -0.655  0.000  0.000\n```\n:::\n:::\n\n\nInteraction:\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nm2 <- lmer(stress ~ 1 + time + group + time*group +\n             (1 | ppt), data = simMIX)\nsummary(m2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed model fit by REML ['lmerMod']\nFormula: stress ~ 1 + time + group + time * group + (1 | ppt)\n   Data: simMIX\n\nREML criterion at convergence: 1096.5\n\nScaled residuals: \n     Min       1Q   Median       3Q      Max \n-1.83946 -0.53326 -0.05639  0.53766  2.31546 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n ppt      (Intercept) 184.82   13.595  \n Residual              43.26    6.577  \nNumber of obs: 150, groups:  ppt, 50\n\nFixed effects:\n                          Estimate Std. Error t value\n(Intercept)                 52.840      3.020  17.494\ntimeDuring                  -3.200      1.860  -1.720\ntimePost                    -6.760      1.860  -3.634\ngroupTreatment               1.920      4.272   0.449\ntimeDuring:groupTreatment  -21.120      2.631  -8.028\ntimePost:groupTreatment    -28.440      2.631 -10.810\n\nCorrelation of Fixed Effects:\n            (Intr) tmDrng timPst grpTrt tmDr:T\ntimeDuring  -0.308                            \ntimePost    -0.308  0.500                     \ngroupTrtmnt -0.707  0.218  0.218              \ntmDrng:grpT  0.218 -0.707 -0.354 -0.308       \ntmPst:grpTr  0.218 -0.354 -0.707 -0.308  0.500\n```\n:::\n:::\n\n\n:::frame\n__Comparison with `aov()`__  \n\nAs we did with the simple repeated measures, we can also compare the sums of squares breakdown for the LMM (`m2`) by calling `anova()` on the `lmer()` model.\n\nFirst with `aov()`:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nm3 <- aov(stress ~ time + group + time*group +\n            Error(ppt), data = simMIX)\nsummary(m3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nError: ppt\n          Df Sum Sq Mean Sq F value   Pr(>F)    \ngroup      1   7993    7993   13.37 0.000633 ***\nResiduals 48  28691     598                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nError: Within\n           Df Sum Sq Mean Sq F value Pr(>F)    \ntime        2  11360    5680  131.31 <2e-16 ***\ntime:group  2   5452    2726   63.01 <2e-16 ***\nResiduals  96   4153      43                   \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\nAnd then summarise:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nanova(m2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n           npar  Sum Sq Mean Sq F value\ntime          2 11360.4  5680.2 131.305\ngroup         1   578.5   578.5  13.373\ntime:group    2  5452.0  2726.0  63.014\n```\n:::\n:::\n\n\n:::\n\nFor ease, lets compare all models with a parametric bootstrap likelihood ratio test:\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(pbkrtest)\nPBmodcomp(m1, m0)\nPBmodcomp(m2, m1)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output .cell-output-stdout}\n```\nBootstrap test; time: 50.95 sec; samples: 1000; extremes: 0;\nlarge : stress ~ 1 + time + group + (1 | ppt)\nstress ~ 1 + (1 | ppt)\n         stat df   p.value    \nLRT    90.348  3 < 2.2e-16 ***\nPBtest 90.348     0.000999 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nBootstrap test; time: 54.92 sec; samples: 1000; extremes: 0;\nlarge : stress ~ 1 + time + group + time * group + (1 | ppt)\nstress ~ 1 + time + group + (1 | ppt)\n         stat df   p.value    \nLRT    83.853  2 < 2.2e-16 ***\nPBtest 83.853     0.000999 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\nAnd extract some bootstrap 95% CIs\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nconfint(m2,method=\"boot\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                               2.5 %      97.5 %\n.sig01                     11.063915  16.8989137\n.sigma                      5.570576   7.3318954\n(Intercept)                46.958215  58.9035049\ntimeDuring                 -6.598935  -0.1161317\ntimePost                  -10.473009  -3.1302747\ngroupTreatment             -7.001190  10.0517531\ntimeDuring:groupTreatment -26.395306 -16.1101659\ntimePost:groupTreatment   -33.665532 -23.2588741\n```\n:::\n:::\n\n\n\n## Check Model\n\nThe residuals look reasonably normally distributed, and there seems to be fairly constant variance across the linear predictor. We might be a little concerned about the potential tails of the plot below, at which residuals don't appear to have a mean of zero\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplot(m2, type = c(\"p\",\"smooth\"))\n```\n\n::: {.cell-output-display}\n![](example_02_intervention_files/figure-html/unnamed-chunk-16-1.png){fig-align='center' width=672}\n:::\n\n```{.r .cell-code}\nplot(m2, sqrt(abs(resid(.)))~fitted(.))\n```\n\n::: {.cell-output-display}\n![](example_02_intervention_files/figure-html/unnamed-chunk-16-2.png){fig-align='center' width=672}\n:::\n\n```{.r .cell-code}\nlibrary(lattice)\nqqmath(m2)\n```\n\n::: {.cell-output-display}\n![](example_02_intervention_files/figure-html/unnamed-chunk-16-3.png){fig-align='center' width=672}\n:::\n:::\n\nRandom effects are (roughly) normally distributed:\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nrans <- as.data.frame(ranef(m2)$ppt)\nggplot(rans, aes(sample = `(Intercept)`)) + \n  stat_qq() + stat_qq_line() +\n  labs(title=\"random intercept\")\n```\n\n::: {.cell-output-display}\n![](example_02_intervention_files/figure-html/unnamed-chunk-17-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n# Visualise Model\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(sjPlot)\nplot_model(m2, type=\"int\")\n```\n\n::: {.cell-output-display}\n![](example_02_intervention_files/figure-html/unnamed-chunk-18-1.png){fig-align='center' width=672}\n:::\n\n```{.r .cell-code}\nplot_model(m2, type=\"re\") # an alternative: dotplot.ranef.mer(ranef(m1))\n```\n\n::: {.cell-output-display}\n![](example_02_intervention_files/figure-html/unnamed-chunk-18-2.png){fig-align='center' width=672}\n:::\n:::\n\n\n# Interpret model\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n:::int\n\nStress at each study time-point (pre-, during- and post-intervention) was modeled using linear mixed effects models, with by-participant random intercepts, and the incremental addition of time, condition (control vs treatment) and their interaction. An interaction between time and condition improved model fit over the model without the interaction (Parametric bootstrap LRT 83.85, p < .001), suggesting that patterns of change over time in stress levels differed for the treatment group from the control group.  \nResult show that for the control group, stress did not show clear change between time-points 1 and 2 (-3.2, 95% CI [-6.92 -- 0.32]), but by time-point 3 had reduced relative to time-point 1 by -6.76 [-10.58 -- -3.3] points. Prior to the intervention (time-point 1), the treatment group did not appear to differ from the control group with respect to their level of stress, but showed an *additional* -21.12 [-26.75 -- -15.63] point change by time-point 2 and -28.44 [-33.75 -- -23.23] points by the end of the study (time-point 3). This pattern of results is shown in Figure 1. \n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Figure 1: Stress levels over time for control and treatment groups, with bootstrap prediction intervals (R = 2000)](example_02_intervention_files/figure-html/res-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n:::\n\n\n",
    "supporting": [
      "example_02_intervention_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\r\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}