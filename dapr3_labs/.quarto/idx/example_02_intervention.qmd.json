{"title":"Analysis Example: Intervention","markdown":{"yaml":{"title":"Analysis Example: Intervention","link-citations":"yes","code-fold":true,"params":{"SHOW_SOLS":true,"TOGGLE":true}},"headingText":"Overview","containsRefs":false,"markdown":"\n```{r setup, include=F}\nknitr::opts_chunk$set(message = F, warning = F, fig.align = 'center')\n```\n\n:::frame\n \nEach of these pages provides an analysis run through for a different type of design. Each document is structured in the same way:  \n\n  - First the data and research context is introduced. For the purpose of these tutorials, we will only use examples where the data can be shared - either because it is from an open access publication, or because it is unpublished or simulated. \n  - Second, we go through any tidying of the data that is required, before creating some brief descriptives and visualizations of the raw data.\n  - Then, we conduct an analysis. Where possible, we translate the research questions into formal equations prior to fitting the models in **lme4**. Model comparisons are conducted, along with checks of distributional assumptions on our model residuals. \n  - Finally, we visualize and interpret our analysis.\n  \nPlease note that there will be only minimal explanation of the steps undertaken here, as these pages are intended as example analyses rather than additional labs readings. Please also be aware that there are many decisions to be made throughout conducting analyses, and it may be the case that you disagree with some of the choices we make here. As always with these things, it is how we justify our choices that is important. We warmly welcome any feedback and suggestions to improve these examples: please email [ug.ppls.stats@ed.ac.uk](mailto:ug.ppls.stats@ed.ac.uk). \n\n:::\n \n\nIntervention studies are where the researchers _intervenes_ (e.g. through administration of a drug or treatment) as part of the study\n\nThe data used for this worked example are simulated to represent data from 50 participants, each measured at 3 different time-points (pre, during, and post) on a measure of stress. Half of the participants are in the control group, and half are in the treatment group (e.g. half received some cognitive behavioural therapy (CBT), half did not). \n\n```{r}\nset.seed(983)\nlibrary(tidyverse)\nsimMIX <- tibble(\n  ppt = factor(rep(paste(\"ID\", 1:50, sep=\"\"),each=3)),\n  ppt_int = rep(rnorm(50,0,15), each=3), \n  stress = round(\n    c(rnorm(75,c(50,45,42),sd=c(5, 6, 5)),\n      rnorm(75,c(55,30,20),sd=c(6, 10, 5))) + ppt_int,\n    0),\n  time = as_factor(rep(c(\"Pre\", \"During\", \"Post\"), 50)),\n  group = as_factor(c(rep(\"Control\", 75), rep(\"Treatment\", 75)))\n) %>% select(-ppt_int)\n```\n\n# Data Wrangling\n\nBecause we simulated our data, it is already nice and tidy. Each observation is a row, and we have variable indicating participant identifier (the `ppt` variable).  \n```{r}\nsummary(simMIX)\nbind_rows(head(simMIX), tail(simMIX))\n```\n# Descriptives\n\nWe now have two factors of interest, scores over `Time` and by `Group`. So we do our descriptive statistics by multiple grouping factors.\n\n```{r}\nsumMIX <- \n  simMIX %>%\n  group_by(time, group) %>%\n  summarise(\n    N = n_distinct(ppt),\n    Mean = round(mean(stress, na.rm=T),2),\n    SD = round(sd(stress, na.rm=T),2)\n    )\n```\n\n\n```{r}\nlibrary(kableExtra)\nkable(sumMIX) %>%\n  kable_styling(\"striped\")\n```\n\n# Visualizations\n\nWe can use a violin plot to visualize our data.\n\n```{r warning=FALSE, message=FALSE}\nsimMIX %>% \n  ggplot(aes(x=time, y=stress, color=group, fill=group))  + \n  geom_violin(alpha = .25) + \n  geom_dotplot(binaxis='y', stackdir='center', position=position_dodge(1),\n               dotsize = 0.5) +\n  labs(x=\"Time\", y = \"Stress Score\", \n       title=\"Stress over Time by Treat Vs Control\", color=\"Condition\", fill=\"Condition\")\n```\n\nIt is useful to note that the violin plot contains much of the same information that a more traditional boxplot would have, but provides more information on the actual distribution with groups as it draws on density plots.\n\nWhat we can see here is that over time, the control group shows little change, but the treatment group shows distinct declines.  \nWe can also consider line plots with separate facets for each condition:\n```{r}\nsimMIX %>% \n  ggplot(aes(x=time, y=stress, col=group))  + \n  geom_point(size=3, alpha=.4)+\n  geom_line(aes(group=ppt), alpha=.3)+\n  stat_summary(geom=\"pointrange\", col=\"black\")+\n  facet_wrap(~group)+\n  labs(x=\"Time\", y = \"Stress Score\", \n       title=\"Stress over Time by Treat Vs Control\", color=\"Condition\", fill=\"Condition\")+\n  theme_minimal()\n```\n\n\n# Analysis\n\n## Equations\n\n\n$$\n\\begin{aligned}\n  \\operatorname{stress}_{i[j]}  &= \\beta_{0i} + \\beta_{1i}(\\operatorname{timeDuring}_j) + \\beta_{2i}(\\operatorname{timePost}_j) + \\varepsilon_{i[j]} \\\\\n  \\beta_{0i} &= \\gamma_{00} + \\gamma_{01}(\\operatorname{groupTreatment}_i) + \\zeta_{0i} \\\\\n  \\beta_{1i} &= \\gamma_{10} + \\gamma_{11}(\\operatorname{groupTreatment}_i) \\\\\n  \\beta_{2i} &= \\gamma_{20} + \\gamma_{21}(\\operatorname{groupTreatment}_i) \\\\\n  & \\text{for ppt i = 1,} \\dots \\text{, I}\n\\end{aligned}\n$$\n\n## Fitting the models\n\n```{r}\nlibrary(lme4)\n```\n\n\nBase model:\n\n```{r}\nm0 <- lmer(stress ~ 1 +\n             (1 | ppt), data = simMIX)\nsummary(m0)\n```\n\nMain effects: \n```{r}\nm1 <- lmer(stress ~ 1 + time + group +\n             (1 | ppt), data = simMIX)\nsummary(m1)\n```\n\nInteraction:\n```{r}\nm2 <- lmer(stress ~ 1 + time + group + time*group +\n             (1 | ppt), data = simMIX)\nsummary(m2)\n```\n\n:::frame\n__Comparison with `aov()`__  \n\nAs we did with the simple repeated measures, we can also compare the sums of squares breakdown for the LMM (`m2`) by calling `anova()` on the `lmer()` model.\n\nFirst with `aov()`:\n\n```{r}\nm3 <- aov(stress ~ time + group + time*group +\n            Error(ppt), data = simMIX)\nsummary(m3)\n```\n\nAnd then summarise:\n\n```{r}\nanova(m2)\n```\n\n:::\n\nFor ease, lets compare all models with a parametric bootstrap likelihood ratio test:\n```{r eval=F}\nlibrary(pbkrtest)\nPBmodcomp(m1, m0)\nPBmodcomp(m2, m1)\n```\n```{r echo=F}\nlibrary(pbkrtest)\nrescomp1 <- PBmodcomp(m1, m0)\nrescomp1\nrescomp2 <- PBmodcomp(m2, m1)\nrescomp2\n```\nAnd extract some bootstrap 95% CIs\n```{r}\nconfint(m2,method=\"boot\")\n```\n\n\n## Check Model\n\nThe residuals look reasonably normally distributed, and there seems to be fairly constant variance across the linear predictor. We might be a little concerned about the potential tails of the plot below, at which residuals don't appear to have a mean of zero\n```{r}\nplot(m2, type = c(\"p\",\"smooth\"))\nplot(m2, sqrt(abs(resid(.)))~fitted(.))\nlibrary(lattice)\nqqmath(m2)\n```\nRandom effects are (roughly) normally distributed:\n```{r}\nrans <- as.data.frame(ranef(m2)$ppt)\nggplot(rans, aes(sample = `(Intercept)`)) + \n  stat_qq() + stat_qq_line() +\n  labs(title=\"random intercept\")\n```\n\n# Visualise Model\n\n```{r}\nlibrary(sjPlot)\nplot_model(m2, type=\"int\")\nplot_model(m2, type=\"re\") # an alternative: dotplot.ranef.mer(ranef(m1))\n```\n\n# Interpret model\n\n```{r echo=FALSE}\nresest <- cbind(c(0,0,fixef(m2)), confint(m2,method=\"boot\"))\nresest <- round(resest,2)\n```\n\n:::int\n\nStress at each study time-point (pre-, during- and post-intervention) was modeled using linear mixed effects models, with by-participant random intercepts, and the incremental addition of time, condition (control vs treatment) and their interaction. An interaction between time and condition improved model fit over the model without the interaction (Parametric bootstrap LRT `r round(as.data.frame(rescomp2)[2,1],2)`, p < .001), suggesting that patterns of change over time in stress levels differed for the treatment group from the control group.  \nResult show that for the control group, stress did not show clear change between time-points 1 and 2 (`r resest[4,1]`, 95% CI [`r resest[4,2]` -- `r resest[4,3]`]), but by time-point 3 had reduced relative to time-point 1 by `r resest[5,1]` [`r resest[5,2]` -- `r resest[5,3]`] points. Prior to the intervention (time-point 1), the treatment group did not appear to differ from the control group with respect to their level of stress, but showed an *additional* `r resest[7,1]` [`r resest[7,2]` -- `r resest[7,3]`] point change by time-point 2 and `r resest[8,1]` [`r resest[8,2]` -- `r resest[8,3]`] points by the end of the study (time-point 3). This pattern of results is shown in Figure 1. \n\n\n```{r res, echo=F, fig.cap=\"Figure 1: Stress levels over time for control and treatment groups, with bootstrap prediction intervals (R = 2000)\"}\npreddata <- \n  expand_grid(\n    time = levels(simMIX$time),\n    group = levels(simMIX$group)\n  )\nmyfun = function(fit){\n  predict(fit, newdata=preddata, re.form=NA)\n}\nplotdat <- bootMer(m2, myfun, nsim = 2000, use.u = FALSE)\nplotdat <- \n  as_tibble(plotdat$t) %>% mutate(\n    sim = 1:n()\n  )\n\nnames(plotdat)[1:6] <- as.character(interaction(preddata$time, preddata$group))\n\nplotdat %>% \n  pivot_longer(1:6, names_to = \"tc\",values_to=\"est\") %>%\n  separate(tc, into=c(\"time\",\"group\"),\"\\\\.\") %>%\n  ggplot(.,aes(x=time, y=est, col = group))+\n  geom_line(aes(group=interaction(sim,group)),alpha=.01)+\n  stat_summary(geom=\"path\",aes(group=group), col=\"black\", lty=\"dashed\")+\n  stat_summary(geom=\"point\",aes(fill=group), size = 4, shape = 21, col=\"black\")+\n  scale_x_discrete(limits=c(\"Pre\",\"During\",\"Post\"))+\n  theme_minimal()\n```\n\n:::\n\n\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"include-in-header":["assets/toggling.html"],"number-sections":false,"output-file":"example_02_intervention.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.0.38","toc_float":true,"theme":["united","assets/style-labs.scss"],"code-copy":false,"title":"Analysis Example: Intervention","link-citations":"yes","params":{"SHOW_SOLS":true,"TOGGLE":true}},"extensions":{"book":{"multiFile":true}}}}}