---
title: "Title"
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup
#| include: false

library(tidyverse)
library(patchwork)
source('_theme/theme_quarto.R')
```

# Course Overview

```{r}
#| eval: false
#| results: "asis"
block1_name = "multilevel modelling<br>working with group structured data"
block1_lecs = c("regression refresher",
                "introducing multilevel models",
                "more complex groupings",
                "centering, assumptions, and diagnostics",
                "recap")
block2_name = "factor analysis<br>working with multi-item measures"
block2_lecs = c(
  "what is a psychometric test?",
  "using composite scores to simplify data (PCA)",
  "uncovering underlying constructs (EFA)",
  "more EFA",
  "recap"
  )

source("https://raw.githubusercontent.com/uoepsy/junk/main/R/course_table.R")
course_table(block1_name,block2_name,block1_lecs,block2_lecs,week=5)
```


# VISUAL RECAP

## example

> **How do reaction times change with increasing sleep deprivation?** <span style="opacity:.4">Participants measured over 10 days of sleep deprivation.</span>  


## lm: a line

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide1.PNG")
```

## lm: a line (2)

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide13.PNG")
```

## lm: a line (3)

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide2.PNG")
```

## lm: lines and differences between them

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide3.PNG")
```

## lmer: lines with a distribution of intercepts

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide4.PNG")
```

## lmer: lines with a distribution of intercepts (2)

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide5.PNG")
```

## lmer: lines with a distribution of intercepts (3)

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide6.PNG")
```

## lmer: lines with a distribution of intercepts (4)

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide7.PNG")
```

## lmer: and with a distribution of slopes

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide8.PNG")
```


## lmer: and with a distribution of slopes (2)

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide9.PNG")
```

## fixed and random

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide10.PNG")
```

## nested: distributions of distributions 

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide11.PNG")
```

## crossed: distributions and distributions

```{r echo=FALSE, out.height="600px"}
knitr::include_graphics("img_sandbox/rt_example/Slide12.PNG")
```


# The research process: model specification

## Study 

In 2010 A US state's commissioner for education was faced with growing community concern about rising levels of adolescent antisocial behaviours. 

After a series of focus groups, the commissioner approved the trialing of an intervention in which yearly Parent Management Training (PMT) group sessions were offered to the parents of a cohort of students entering 10 different high schools. Every year, the parents were asked to fill out an informant-based version of the Aggressive Behaviour Scale (ABS), measuring verbal and physical abuse, socially inappropriate behavior, and resisting care. Where possible, the same parents were followed up throughout the child's progression through high school. Alongside this, parents from a cohort of students entering 10 further high schools in the state were recruited to also complete the same informant-based ABS, but were not offered the PMT group sessions.  
The commissioner has two main questions: **Does the presentation of aggressive behaviours increase as children enter the secondary school system? If so, is there any evidence for the effectiveness of Parent Management Training (PMT) group sessions in curbing the rise of aggressive behaviors during a child's transition into the secondary school system?**  

The data is available at https://uoepsy.github.io/data/abs_intervention.csv 

## Data

```{r echo=FALSE}
absint<-read_csv("https://uoepsy.github.io/data/abs_intervention.csv")

tibble(
  variable = names(absint),
  description = c("Name of school","Participant number","Age of participant (in years) at observation","Informant-based Aggressive Behaviour Scale (ABS) score (range 0 to 100)","Whether or not the school was part of the intervention group in which Parent Management Training (PMT) group sessions were offered to the parents")
) %>% knitr::kable()
```

```{r}
absint<-read_csv("https://uoepsy.github.io/data/abs_intervention.csv") %>% mutate(interv=factor(interv))
head(absint)
```

## Outcome and Fixed Effects  

.br2.f4.gray.bg-white[
(g)lmer(**outcome** ~ fixed effects + (random effects | grouping structure), family = error distribution)
]



::::{.columns}
:::{.column width="50%"}
- What are we interested in explaining/predicting?  
:::

:::{.column width="50%"}
> Does the presentation of aggressive behaviours increase as children enter the secondary school system? If so, is there any evidence for the effectiveness of Parent Management Training (PMT) group sessions in curbing the rise of aggressive behaviors during a child's transition into the secondary school system?

:::
::::


## Outcome and Fixed Effects  


.br2.f4.gray.bg-white[
(g)lmer(**outcome** ~ fixed effects + (random effects | grouping structure), family = error distribution)
]


::::{.columns}
:::{.column width="50%"}
- What are we interested in explaining/predicting?  
:::

:::{.column width="50%"}
> 1. Does the presentation of aggressive behaviours increase as children enter the secondary school system? 
> 2. If so, is there any evidence for the effectiveness of Parent Management Training (PMT) group sessions in curbing the rise of aggressive behaviors during a child's transition into the secondary school system?

:::
::::

## Outcome and Fixed Effects  

.br2.f4.gray.bg-white[
**(g)lmer**(outcome ~ fixed effects + (random effects | grouping structure), **family = error distribution**)
]


::::{.columns}
:::{.column width="50%"}

- What are we interested in explaining/predicting?  

  - How is this measured?
  
:::

:::{.column width="50%"}

> 1. Does the presentation of aggressive behaviours increase as children enter the secondary school system? 
> 2. If so, is there any evidence for the effectiveness of Parent Management Training (PMT) group sessions in curbing the rise of aggressive behaviors during a child's transition into the secondary school system?

```{r echo=FALSE, fig.width=3,fig.height=2}
ggplot(absint, aes(x=ABS))+
  geom_histogram()
```

:::
::::

## Outcome and Fixed Effects  

.br2.f4.gray.bg-white[
(g)lmer(outcome ~ **fixed effects** + (random effects | grouping structure), family = error distribution)
]



::::{.columns}
:::{.column width="50%"}

- What are we interested in explaining/predicting?  

  - How is this measured?

- What variables are we interested in explaining this by?  

:::

:::{.column width="50%"}

> 1. Does the presentation of aggressive behaviours increase as children enter the secondary school system? 
> 2. If so, is there any evidence for the effectiveness of Parent Management Training (PMT) group sessions in curbing the rise of aggressive behaviors during a child's transition into the secondary school system?

```{r echo=FALSE}
head(absint, 4L) %>% mutate(interv=as.numeric(as.character(interv)), ABS = round(ABS,1)) %>% rbind("...")  %>% as_tibble() %>% kable()
```


:::
::::

## Within & Between Effects

.br2.f4.gray.bg-white[
(g)lmer(outcome ~ **fixed effects** + (random effects | grouping structure), family = error distribution)
]


::::{.columns}
:::{.column width="50%"}

- Are our questions about the effects of our predictors specifically in reference to _group means_ of predictors?  

  - "the effect of being higher on $x$ *__for a__* group"  
  
  - "the effect of a group being *__on average__* higher on $x$" 


:::

:::{.column width="50%"}

> 1. Does the presentation of aggressive behaviours increase as children enter the secondary school system? 
> 2. If so, is there any evidence for the effectiveness of Parent Management Training (PMT) group sessions in curbing the rise of aggressive behaviors during a child's transition into the secondary school system?


:::
::::


## The Grouping Structure  

.br2.f4.gray.bg-white[
(g)lmer(outcome ~ fixed effects + (random effects | grouping structure), family = error distribution)
]


::::{.columns}
:::{.column width="50%"}

- In what different ways can we group our data?   

:::

:::{.column width="50%" .fragment}
```{r echo=FALSE}
head(absint, 4L) %>% mutate(interv=as.numeric(as.character(interv)), ABS = round(ABS,1)) %>% rbind("...")  %>% as_tibble() %>% kable()
```
:::
::::


## The Grouping Structure  

.br2.f4.gray.bg-white[
(g)lmer(outcome ~ fixed effects + (random effects | grouping structure), family = error distribution)
]


::::{.columns}
:::{.column width="50%"}

- In what different ways can we group our data?   

- Of the different ways we can group our data, which groupings are of specific inferential interest?  

- Of the different ways we can group our data, which groupings do we think of as a random sample from a general population of groups? 

:::

:::{.column width="50%"}

> 1. Does the presentation of aggressive behaviours increase as children enter the secondary school system? 
> 2. If so, is there any evidence for the effectiveness of Parent Management Training (PMT) group sessions in curbing the rise of aggressive behaviors during a child's transition into the secondary school system?

```{r echo=FALSE}
head(absint, 4L) %>% mutate(interv=as.numeric(as.character(interv)), ABS = round(ABS,1)) %>% rbind("...")  %>% as_tibble() %>% kable()
```

:::
::::

## The Grouping Structure  

.br2.f4.gray.bg-white[
(g)lmer(outcome ~ **fixed effects** + (random effects | grouping structure), family = error distribution)
]


::::{.columns}
:::{.column width="50%"}

- In what different ways can we group our data?   

- **Of the different ways we can group our data, which groupings are of specific inferential interest?**  

- Of the different ways we can group our data, which groupings do we think of as a random sample from a general population of groups? 


:::

:::{.column width="50%"}
> 1. Does the presentation of aggressive behaviours increase as children enter the secondary school system? 
> 2. If so, is there any evidence for the effectiveness of Parent Management Training (PMT) group sessions in curbing the rise of aggressive behaviors during a child's transition into the secondary school system?

```{r echo=FALSE}
head(absint, 4L) %>% mutate(interv=as.numeric(as.character(interv)), ABS = round(ABS,1)) %>% rbind("...")  %>% as_tibble() %>% kable()
```
:::
::::


## The Grouping Structure  

.br2.f4.gray.bg-white[
(g)lmer(outcome ~ fixed effects + (random effects | **grouping structure**), family = error distribution)
]


::::{.columns}
:::{.column width="50%"}

- In what different ways can we group our data?   

- Of the different ways we can group our data, which groupings are of specific inferential interest?  

- **Of the different ways we can group our data, which groupings do we think of as a random sample from a general population of groups?** 

:::

:::{.column width="50%"}

> 1. Does the presentation of aggressive behaviours increase as children enter the secondary school system? 
> 2. If so, is there any evidence for the effectiveness of Parent Management Training (PMT) group sessions in curbing the rise of aggressive behaviors during a child's transition into the secondary school system?

```{r echo=FALSE}
head(absint, 4L) %>% mutate(interv=as.numeric(as.character(interv)), ABS = round(ABS,1)) %>% rbind("...")  %>% as_tibble() %>% kable()
```


:::
::::


## The Grouping Structure  

.br2.f4.gray.bg-white[
(g)lmer(outcome ~ fixed effects + (random effects | **grouping structure**), family = error distribution)
]


::::{.columns}
:::{.column width="50%"}

- In what different ways can we group our data?   

- Of the different ways we can group our data, which groupings are of specific inferential interest?  

- Of the different ways we can group our data, which groupings do we think of as a random sample from a general population of groups? 

  - Is there more than one grouping of this sort, and if so, are these groupings nested? Are the labels unique?  
  
  - For each level, how many groups have we sampled?  

:::

:::{.column width="50%" .fragment}

```{r}
nrow(absint)
absint %>% 
  mutate(schoolppt = interaction(schoolid,ppt)) %>%
  summarise(across(everything(), n_distinct))
```

:::
::::



## The Grouping Structure  

.br2.f4.gray.bg-white[
(g)lmer(outcome ~ fixed effects + (random effects | **grouping structure**), family = error distribution)
]



::::{.columns}
:::{.column width="50%"}

- In what different ways can we group our data?   

- Of the different ways we can group our data, which groupings are of specific inferential interest?  

- Of the different ways we can group our data, which groupings do we think of as a random sample from a general population of groups? 

  - Is there more than one grouping of this sort, and if so, are these groupings nested? Are the labels unique?  
  
  - For each level, how many groups have we sampled?  
  
:::

:::{.column width="50%"}

```{r}
table(absint$schoolid, absint$ppt)
```

:::
::::


## Random Intercepts and Slopes

.br2.f4.gray.bg-white[
(g)lmer(outcome ~ fixed effects + (**random effects** | grouping structure), family = error distribution)
]


::::{.columns}
:::{.column width="50%"}

- Which of our fixed effects can vary for our random groups?  

  - "does a single group have multiple _distinct_ values for $x$?"  
  
  - "for the data from only one of our groups, can we estimate $y \sim x$?"


:::

:::{.column width="50%"}

All the data:
```{r echo=FALSE, fig.asp=.4}
library(patchwork)
absint %>% 
  ggplot(.,aes(x=ABS))+
  geom_histogram() + 
absint %>% 
  ggplot(.,aes(x=age, y=ABS))+
  geom_point() + 
absint %>% mutate(interv=factor(interv)) %>% 
  ggplot(.,aes(x=interv, y=ABS))+
  geom_point() + 
  scale_x_discrete(drop=FALSE)
```
Data from School == "Central High":
```{r echo=FALSE, fig.asp=.4}
library(patchwork)
absint %>% filter(schoolid == "Central High") %>% 
  ggplot(.,aes(x=ABS))+
  geom_histogram() + 
absint %>% filter(schoolid == "Central High") %>%
  ggplot(.,aes(x=age, y=ABS))+
  geom_point() + 
absint %>% mutate(interv=factor(interv)) %>% filter(schoolid == "Central High") %>%
  ggplot(.,aes(x=interv, y=ABS))+
  geom_point() + 
  scale_x_discrete(drop=FALSE)
```

:::
::::


## Random Intercepts and Slopes

.br2.f4.gray.bg-white[
(g)lmer(outcome ~ fixed effects + (**random effects** | grouping structure), family = error distribution)
]



::::{.columns}
:::{.column width="50%"}

- Which of our fixed effects can vary for our random groups?  

  - "does a single group have multiple values for $x$?"  
  
  - "for the data from only one of our groups, can we estimate $y \sim x$?"


:::

:::{.column width="50%"}

All the data:
```{r echo=FALSE, fig.asp=.4}
library(patchwork)
absint %>% 
  ggplot(.,aes(x=ABS))+
  geom_histogram() + 
absint %>% 
  ggplot(.,aes(x=age, y=ABS))+
  geom_point() + 
absint %>% mutate(interv=factor(interv)) %>% 
  ggplot(.,aes(x=interv, y=ABS))+
  geom_point() + 
  scale_x_discrete(drop=FALSE)
```
Data from School == "Central High", Participant == "1":
```{r echo=FALSE, fig.asp=.4}
library(patchwork)
absint %>% filter(schoolid == "Central High", ppt == 1) %>% 
  ggplot(.,aes(x=ABS))+
  geom_histogram() +
absint %>% filter(schoolid == "Central High", ppt == 1) %>%
  ggplot(.,aes(x=age, y=ABS))+
  geom_point() + 
absint %>% mutate(interv=factor(interv)) %>% filter(schoolid == "Central High", ppt == 1) %>%
  ggplot(.,aes(x=interv, y=ABS))+
  geom_point() + 
  scale_x_discrete(drop=FALSE)
```

:::
::::


## Our model  

.br2.f4.gray.bg-white[
(g)lmer(outcome ~ fixed effects + (random effects | grouping structure), family = error distribution)
]


.br2.f4.green.bg-white[
&nbsp; &nbsp; &nbsp; lmer(ABS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ~ age * interv + (1 + age &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; schoolid&nbsp; /&nbsp; ppt&nbsp; &nbsp; )
]

## Our model  

.br2.f4.gray.bg-white[
(g)lmer(outcome ~ fixed effects + (random effects | grouping structure), family = error distribution)
]

.br2.f4.green.bg-white[
&nbsp; &nbsp; &nbsp; lmer(ABS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ~ ageC * interv + (1 + ageC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; schoolid&nbsp; /&nbsp; ppt&nbsp; &nbsp; )
]


```{r echo=FALSE}
absint <- absint %>% mutate(ageC = age - 12)
head(absint, 4L) %>% mutate(ABS = round(ABS,1), ageC = age-12) %>% mutate(interv=as.character(interv)) %>% rbind("...")  %>% as_tibble() %>% kable()
```

```{r eval=FALSE,echo=FALSE}
absmod <- lmer(ABS ~ ageC * interv + (1 + ageC | schoolid/ppt), data = absint,
     control = lmerControl(optimizer="bobyqa"))

lmer(ABS ~ age * interv + (1 + age | schoolid/ppt) , data = absint %>% mutate(age=age-12),
     control = lmerControl(optimizer="bobyqa")) -> d
VarCorr(d)
broom.mixed::augment(d) %>%
  ggplot(.,aes(x=age,y=.fitted,group=interaction(schoolid,ppt)))+
  geom_line()


lmer(ABS ~ age * interv + (1 + age | schoolid/ppt) , data = absint,
     control = lmerControl(optimizer="bobyqa")) -> d2
VarCorr(d2)
broom.mixed::augment(d2) %>%
  ggplot(.,aes(x=age,y=.fitted,group=interaction(schoolid,ppt)))+
  geom_line()


absint %>% count(interv,schoolid,ppt) %>%
  mutate(age = 0) %>%
  mutate(.fitted = predict(d2, newdata=.)) %>% 
  bind_rows(broom.mixed::augment(d2), .) %>%
  ggplot(.,aes(x=age,y=.fitted,group=interaction(schoolid,ppt)))+
  geom_line()
```


# The research process: model fitting

## Model issues

- Check for convergence issues & singular fits. 
```{r}
absmod <- lmer(ABS ~ ageC * interv + (1 + ageC | schoolid/ppt), data = absint,
     control = lmerControl(optimizer="bobyqa"), REML = TRUE)
```
```{r echo=FALSE}
absmod@optinfo$message
```

## Assumptions

- Check assumptions have been met


::::{.columns}
:::{.column width="50%"}

```{r echo=FALSE, fig.height=4}
plot(absmod,
     type = c("p"), main = "fitted vs residuals")
```


:::

:::{.column width="50%"}

```{r echo=FALSE, fig.height=4}
plot(absmod, 
     form = sqrt(abs(resid(.))) ~ fitted(.),
     type = c("p"), main="scale-location")
```

:::
::::

## Assumptions

```{r echo=FALSE, fig.width=16, fig.height=5}
par(mfrow=c(1,5))
qqnorm(resid(absmod), main = "level one residuals")
qqline(resid(absmod))
qqnorm(ranef(absmod)$schoolid$`(Intercept)`, main="School level random intercepts")
qqline(ranef(absmod)$schoolid$`(Intercept)`)
qqnorm(ranef(absmod)$schoolid$ageC, main="School level random slopes of age")
qqline(ranef(absmod)$schoolid$ageC)
qqnorm(ranef(absmod)$ppt$`(Intercept)`, main="Child level random intercepts")
qqline(ranef(absmod)$ppt$`(Intercept)`)
qqnorm(ranef(absmod)$ppt$ageC, main="Child level random slopes of age")
qqline(ranef(absmod)$ppt$ageC)
par(mfrow=c(1,1))
```

## Assumptions

- Do tests if you want, but beware. Multilevel data tends to have bigger $n$, and these tests are overly sensitive.  

Personally, I prefer plots. 

```{r echo=FALSE, fig.width=16, fig.height=5}
normst <- list(shapiro.test(resid(absmod)),
shapiro.test(ranef(absmod)$schoolid$`(Intercept)`),
shapiro.test(ranef(absmod)$schoolid$ageC),
shapiro.test(ranef(absmod)$ppt$`(Intercept)`),
shapiro.test(ranef(absmod)$ppt$ageC)
)
map_chr(normst, ~paste0(.$method," ",.$data.name," W=",round(.$statistic,2),", p=",round(.$p.value,2)))
```

## Diagnostics

```{r echo=FALSE, fig.width=16, fig.height=5}
library(HLMdiag)
library(patchwork)
l1 <- hlm_influence(absmod, level=1)
l2 <- hlm_influence(absmod, level="ppt:schoolid")
l3 <- hlm_influence(absmod, level="schoolid")
(dotplot_diag(l1$cooksd) + labs(title="Cook's D: Observations")) + 
(dotplot_diag(l2$cooksd) + labs(title="Cook's D: Children"))+ 
(dotplot_diag(l3$cooksd) + labs(title="Cook's D: School")) 
```


# The research process: inference

## Fixed effects


::::{.columns}
:::{.column width="50%"}
```{r}
fixef(absmod)
```
:::

:::{.column width="50%"}
MAP IT TO THE PLOT!!!!
:::
::::


## Fixed effects


::::{.columns}
:::{.column width="50%"}
```{r}
fixef(absmod)
```
:::

:::{.column width="50%"}
```{r fig.asp=.8}
library(sjPlot)
plot_model(absmod, type="int")
```
:::
::::

## Inference


::::{.columns}
:::{.column width="50%"}

- Model comparison

- Parameter estimates


:::

:::{.column width="50%"}

- df approximations
  `parameters::model_parameterS(model, ci_method="kr")`
  `pbkrtest::KRmodcomp(model2,model1)`
- Likelihood Ratio Tests  
  `anova(model1, model2, ...)`
- Bootstrap
  - parametric bootstrap
    `pbkrtest::PBmodcomp()` and `confint(method="boot")`
  - case bootstrap
    `lmeresampler::bootstrap(model, type = "case", resample = c(....))`
    
:::
::::


## Inference

> **Research Questions**  
> 1. Does the presentation of aggressive behaviours increase as children enter the secondary school system? 
> 2. If so, is there any evidence for the effectiveness of Parent Management Training (PMT) group sessions in curbing the rise of aggressive behaviors during a child's transition into the secondary school system?

```{r}
fixef(absmod)
```


## Inference

```{r}
# TODO lmerTest::lmer()
```


## Random effects  

Don't just ignore. They add context to results  

- e.g. they can give a descriptive answer to "should we expect *all* children get more aggressive in secondary school?" 

```{r fig.asp=.6, echo=FALSE}
ggplot(data = data.frame(x = c(-6, 6)), aes(x)) +
  stat_function(fun = dnorm, n = 101, args = list(mean = 1.67, sd = 2.22)) + ylab("") +
  scale_y_continuous(breaks = NULL) + theme_blank() +
  geom_vline(xintercept = 1.67,lty="dotted")+
  labs(x = "slope of ABS ~ age", title="SD ppt:schoolid ageC = 2.22") -> p1

ggplot(data = data.frame(x = c(-6, 6)), aes(x)) +
  stat_function(fun = dnorm, n = 101, args = list(mean = 1.67, sd = 0.65)) + ylab("") +
  scale_y_continuous(breaks = NULL) + theme_blank() +
  geom_vline(xintercept = 1.67,lty="dotted")+
  labs(x = "slope of ABS ~ age", title = "SD ppt:schoolid ageC = 0.65") -> p2

p1 | p2

```



## Random effects  

Don't just ignore. They add context to results  

- e.g. they can give a descriptive answer to "should we expect *all* children get more aggressive in secondary school?" 

```{r fig.asp=.6, echo=FALSE}
plotline = MASS::mvrnorm(n=250, mu=fixef(absmod)[1:2],Sigma=VarCorr(absmod)[[1]]) %>%
  as_tibble() |> mutate(interv="0")
plotline2 = MASS::mvrnorm(n=250, mu=c(sum(fixef(absmod)[c(1,3)]),sum(fixef(absmod)[c(2,4)])),Sigma=VarCorr(absmod)[[1]]) %>%
  as_tibble() |> mutate(interv="1")

ggplot(absint, aes(x=ageC, y=ABS))+
  geom_point(col=NA)+
  guides(col="none")+
  geom_abline(data=plotline, aes(intercept=`(Intercept)`,slope=ageC,col=interv),alpha=.1)+
  geom_abline(intercept=fixef(absmod)[1],slope=fixef(absmod)[2])+
  geom_abline(data=plotline2, aes(intercept=`(Intercept)`,slope=ageC,col=interv),alpha=.1)+ 
  geom_abline(intercept=sum(fixef(absmod)[c(1,3)]),slope=sum(fixef(absmod)[c(2,4)]))-> p1


ss = VarCorr(absmod)[[1]]-4.5
ss = pracma::nthroot(ss,n=5)
plotline = MASS::mvrnorm(n=250, mu=fixef(absmod)[1:2],Sigma=ss) %>%
  as_tibble() |> mutate(interv="0")
plotline2 = MASS::mvrnorm(n=250, mu=c(sum(fixef(absmod)[c(1,3)]),sum(fixef(absmod)[c(2,4)])),Sigma=ss) %>%
  as_tibble() |> mutate(interv="1")

ggplot(absint, aes(x=ageC, y=ABS))+
  geom_point(col=NA)+
  guides(col="none")+
  geom_abline(data=plotline, aes(intercept=`(Intercept)`,slope=ageC,col=interv),alpha=.1)+
  geom_abline(intercept=fixef(absmod)[1],slope=fixef(absmod)[2])+
  geom_abline(data=plotline2, aes(intercept=`(Intercept)`,slope=ageC,col=interv),alpha=.1)+ 
  geom_abline(intercept=sum(fixef(absmod)[c(1,3)]),slope=sum(fixef(absmod)[c(2,4)]))-> p2

p1 | p2
```

# The research process: reporting

## Reporting the analysis process

- Data cleaning outlier/data removal, transformations _prior to_ analysis.  

- Unplanned transformations and data removal which are carried out in order to meet assumptions.  

:::{.fragment}

- Specify all fixed effects (explanatory variables & covariates).  
Link them to explicitly stated research questions/hypotheses. 

- Explicitly state the hierarchical structure of the data and of the model.  
Specify random effects according to the sampling units (schools/children etc) with which they interact. 

:::

:::{.fragment}

- Planned structure of random effects to be fitted   

- Procedure to be used to decide on final random effect structure.  

:::

:::{.fragment}

- State clearly the relevant test/comparison/parameter estimate of interest.  
Link to explicitly stated research questions/hypotheses.  

  - Method you plan to use to conduct inference (e.g. LRT, kr, bootstrap)
  - Any model comparisons should be clearly stated so that the reader understands the structure of *both* models being compared.  


:::


## Reporting results


::::{.columns}
:::{.column width="50%"}

- Software packages and versions used to fit the model(s), along with the estimation method (ML/REML) and optimiser used.   

- If proposed model failed to converge:  
  - steps leading to final converging model.  
  - final model structure  
  
:::

:::{.column width="50%"}
For final model:  

- all parameter estimates for fixed effects.  

    - coefficients
    - standard errors and/or confidence intervals
    - associated test statistics, df and p-values (if used)  

- random effects  

  - standard deviation and/or variance for each random effect
  - correlations/covariances if modelled   
  - residual variance/standard deviation
    
:::
::::

## Reporting: text and tables

Tables help a lot!  

:::{.fragment}
But *they are not a substitute for interpretation*  

- Key parameters of interest should also be included in-text, with interpretation.  

:::

```{r eval=FALSE}
library(sjPlot)
tab_model(absmod, show.p = FALSE, df.method="kr")
```

## Visualisations  

- Think about your questions  

.pull-left[
```{r echo=FALSE, fig.asp=.8}
ggplot()+
  labs(y="Outcome",x="Some explanatory variable of interest")
```
]
.pull-right[
> 1. Does the presentation of aggressive behaviours increase as children enter the secondary school system? 
> 2. If so, is there any evidence for the effectiveness of Parent Management Training (PMT) group sessions in curbing the rise of aggressive behaviors during a child's transition into the secondary school system?
]

---
# Visualising the model(s)

.pull-left[
There's always `sjPlot::plot_model()`!
```{r echo=FALSE, fig.asp=.8}
sjPlot::plot_model(absmod, type="int")
```
]
--
.pull-right[
But plotting manually gives you more control:
```{r echo=FALSE, fig.asp=.8}
library(effects)
#effs <- as.data.frame(effect("ageC:interv", absmod))
load("jk_source/effs.RData")

facetlabs <- c(
  `0` = "No Intervention",
  `1` = "Parent Management\nTraining"
)

broom.mixed::augment(absmod) %>%
ggplot(., aes(x=ageC+12,
              col=interv))+
  geom_point(aes(y=ABS), alpha=.1) +
  geom_line(aes(y=ABS,group=interaction(schoolid,ppt)), alpha=.2) +
  scale_color_manual("Intervention",values=c("#BF1932","#88B04B"),
                     labels=c("None","PMT"))+
  guides(fill="none",col="none")+
  labs(y="ABS", x="")+
  facet_grid(~interv, labeller = as_labeller(facetlabs)) -> p1

broom.mixed::augment(absmod) %>%
ggplot(., aes(x=ageC+12,
              col=interv))+
  geom_line(aes(y=.fitted,group=interaction(schoolid,ppt)), alpha=.1) +
  geom_line(data=effs, aes(y=fit), lwd=1)+
  geom_ribbon(data=effs, aes(ymax=upper,ymin=lower, fill=interv), alpha=.2)+
  scale_color_manual("Intervention",values=c("#BF1932","#88B04B"),
                     labels=c("None","PMT"))+
  scale_fill_manual("Intervention",values=c("#BF1932","#88B04B"),
                    labels=c("None","PMT"))+
  labs(y="Model fit", x="- Age (years) -")+
  guides(fill="none",col="none") -> p2

p1 / p2
```
]

---
class: inverse, center, middle, animated, rotateInDownLeft

# End
## Thanks for listening!
