---
title: "<b>WEEK 4<br>Centering Predictors<br>Generalisations</b>"
subtitle: "Data Analysis for Psychology in R 3"
author: "Josiah King"
institute: "Department of Psychology<br/>The University of Edinburgh"
date: "AY 2021-2022"
output:
  xaringan::moon_reader:
    lib_dir: jk_libs/libs
    css: 
      - xaringan-themer.css
      - jk_libs/tweaks.css
    nature:
      beforeInit: "jk_libs/macros.js"
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(digits=4,scipen=2)
options(knitr.table.format="html")
xaringanExtra::use_xaringan_extra(c("tile_view","animate_css","tachyons"))
xaringanExtra::use_extra_styles(
  mute_unhighlighted_code = FALSE
)
xaringanExtra::use_share_again()
library(knitr)
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(patchwork)
knitr::opts_chunk$set(
  dev = "png",
  warning = FALSE,
  message = FALSE,
  cache = FALSE
)
themedapr3 = function(){
  theme_minimal() + 
    theme(text = element_text(size=20))
}
source("jk_source/jk_presfuncs.R")
```

```{r xaringan-themer, include = FALSE}
library(xaringanthemer)
style_mono_accent(
  # base_color = "#0F4C81", # DAPR1
  # base_color = "#BF1932", # DAPR2
  base_color = "#88B04B", # DAPR3 
  # base_color = "#FCBB06", # USMR
  # base_color = "#a41ae4", # MSMR
  header_color = "#000000",
  header_font_google = google_font("Source Sans Pro"),
  header_font_weight = 400,
  code_font_size = "0.7rem",
  text_font_google = google_font("Source Sans Pro", "400", "400i", "600", "600i"),
  code_font_google = google_font("Source Code Pro"),
  extra_css = list(".scroll-output" = list("height"="90%","overflow-y"="scroll"))
)
```


---
class: inverse, center, middle

<h2 style="text-align: left;opacity:0.3;">Part 1: Centering Predictors</h2>
<h2 style="text-align: left;opacity:0.3;">Part 2: GLMM</h2>


---
# Population average vs Cluster Specific  

- **Population average** effects are the association between $x$ and $y$, averaged over the clusters (rather than considering the effect for a typical cluster). 

- **Cluster specific** effects are the association between $x$ and $y$, *holding the cluster constant*. You might think of this as the **within** effect.  



<!-- cluster specific:  -->
<!-- represents the odds of the person being employed if married compared with the odds of the SAME person being employed if not married. -->

<!-- population average: -->
<!-- represents the odds of an AVERAGE married person being employed compared with the odds of an AVERAGE unmarried person being employed. -->

<!-- Rather than saying “AVERAGE”, sometimes I speak loosely and say the odds of a married person “picked at random” being employed compared with the odds of another unmarried person “picked at random” being employed. -->


.pull-left[
```{r}
model <- lm(nworms ~ arrivalt, data = worms_data)
```
```{r echo=FALSE, out.width="300px"}
.pp(summary(model),l=list(c(10:12)))
```
]
.pull-right[

```{r echo=FALSE, fig.asp=.7}
model <- lm(y~x,df)

yhat <- function(p){
  predict(model, newdata=data.frame(x=p))
}

df %>% mutate(
  f = fitted(model)
) %>%
ggplot(.,aes(x=x,y=y))+
  geom_point(size=4, alpha=.3)+
  geom_smooth(method="lm", se=F)+
  geom_segment(aes(y=y, yend = f, x = x, xend = x), alpha=.05) + 
  geom_segment(aes(x=4, xend=5, y=yhat(4), yend=yhat(4)), lty="dashed", col="blue", lwd=1)+
  geom_segment(aes(x=5, xend=5, y=yhat(4), yend=yhat(5)), lty="dashed", col="blue", lwd=1)+
  annotate("text",x=4.5, y=yhat(4)-2, label="1", size=5) + 
  annotate("text",x=5.3, y=mean(yhat(c(4,5))), label="3.29", size=5) + 
  labs(x="arrival at garden\n(hrs past midnight)",y="number of worms caught")+
  themedapr3()
```

]



---
# Centering predictors in LM

- it doesn't do anything to model fit

---
# Centering predictors in MLM

grand mean centering - doesn't do anything

---
# Centering predictors in MLM

group mean centering - entirely within?

---
# Separating out within and between effects

x_gc + xgb + (1 | g)  

x + xgb + (1 | g)

---
# Can help with endogeneity


---
# Summary

---
class: inverse, center, middle, animated, rotateInDownLeft

# End of Part 1

---
class: inverse, center, middle

<h2 style="text-align: left;opacity:0.3;">Part 1: Centering Predictors</h2>
<h2 style="text-align: left;opacity:0.3;">Part 2: GLMM</h2>

---
# Recall lm() and glm()

link function to model outcomes different distributions

---
# lmer() and glmer()


---
# glmer fits can be tricky

scale parameters may help
why? think of a bowl, trying to find min point.


---
# Summary


---
class: inverse, center, middle, animated, rotateInDownLeft

# End of Part 2

---
class: inverse, center, middle



---
# End

